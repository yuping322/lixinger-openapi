# 方法论：资金流监控（A股）

本技能用于**监控A股市场主力资金、散户资金、机构资金的流向，识别资金集中流入/流出的板块和个股**。资金流是市场的血液，资金流向往往领先价格变化，是重要的短中期交易信号。

## 数据口径

### 数据源与字段映射

资金流监控需要以下数据：
- **主力资金流向**：AKShare (`stock_individual_fund_flow_rank`), 东方财富
  - 主力净流入、超大单净流入、大单净流入、中单净流入、小单净流入
  - 日频数据，T日收盘后更新
- **板块资金流向**：AKShare (`stock_sector_fund_flow_rank`), 东方财富
  - 行业板块、概念板块的主力资金流向
  - 日频数据，T日收盘后更新
- **融资融券数据**：AKShare (`stock_margin_detail`), 交易所
  - 融资买入额、融资余额、融券卖出量、融券余额
  - 日频数据，T+1日更新
- **市场数据**：AKShare (`stock_zh_a_hist`)
  - 个股价格、成交量、成交额、换手率
  - 日频数据，实时更新

关键字段：
- `主力净流入`：超大单 + 大单净流入（亿元）
- `主力净流入占比`：主力净流入 / 成交额 (%)
- `超大单净流入`：单笔 >= 100万的净流入（亿元）
- `大单净流入`：单笔 20-100万的净流入（亿元）
- `散户净流入`：中单 + 小单净流入（亿元）
- `资金流入强度`：净流入 / 成交额 (%)

### 时间窗口与频率

- **日频监控**：每日收盘后更新，T日晚间可获取T日数据
- **周频总结**：每周汇总主力流向、板块轮动、重点个股
- **月频趋势**：每月分析资金流向趋势、板块配置变化

建议窗口：
- 短期动量：3日、5日、10日累计净流入
- 中期趋势：20日、60日累计净流入
- 背离检测：5日资金流向 vs 5日价格涨跌幅
- 板块轮动：5日板块资金流向排名变化

## 核心指标

### 指标列表与计算公式

1. **资金流向指标**：
   - `主力净流入 = 超大单净流入 + 大单净流入`
   - `散户净流入 = 中单净流入 + 小单净流入`
   - `N日累计净流入 = Σ(日净流入)` over N days
   - `资金流入强度 = 主力净流入 / 成交额` (%)

2. **资金集中度指标**：
   - `超大单占比 = 超大单净流入 / 主力净流入` (%)
   - `资金集中度 = Top10个股主力净流入 / 市场总主力净流入` (%)
   - `板块集中度 = Top3板块主力净流入 / 市场总主力净流入` (%)

3. **背离指标**：
   - `资金-价格背离 = sign(N日主力净流入) != sign(N日涨跌幅)`
   - `背离强度 = |N日主力净流入百分位 - N日涨跌幅百分位|`
   - `持续背离天数 = 连续背离的交易日数`

4. **板块轮动指标**：
   - `板块资金流入排名 = rank(板块主力净流入)`
   - `板块流入强度 = 板块主力净流入 / 板块成交额` (%)
   - `板块轮动速度 = 5日板块排名变化幅度`

5. **融资融券指标**：
   - `融资净买入 = 融资买入额 - 融资偿还额`
   - `融资余额占比 = 融资余额 / 流通市值` (%)
   - `融资情绪 = (融资余额 - 20日均值) / 20日标准差`

### 标准化方法

- 使用**百分位排名**对资金流入进行标准化（相对252日历史）
- 使用**z-score**检测极端流入/流出（> 2倍标准差）
- 使用**板块相对**计算超配/低配（板块流入占比 - 板块市值占比）
- 使用**移动平均**平滑短期波动（5日MA、20日MA）

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (主力持续流入 + 价格上涨 → 趋势延续):
IF {5日主力累计净流入 > 0 AND 5日涨跌幅 > 0 AND 资金流入强度 >= 3%}
THEN {未来3-5个交易日，价格继续上涨概率 >= 62%，预期涨幅 >= 2%}
CONFIDENCE {0.62; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，流动性好的股票（日成交额 >= 5000万）信号更强}
FAILURE_MODE {主力流入但散户流出（对倒嫌疑）；价格已大幅上涨（追高风险）；市场整体转弱（系统性风险）；成交量萎缩（流入不持续）}

Rule 2 (主力流入 + 价格下跌 → 底部信号):
IF {5日主力累计净流入 > 0 AND 5日涨跌幅 < -3% AND 持续背离天数 >= 3}
THEN {未来5-10个交易日，价格可能见底反弹，预期反弹幅度 >= 3%}
CONFIDENCE {0.58; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，调整幅度 >= 10%的股票信号更强}
FAILURE_MODE {基本面恶化（业绩暴雷、负面公告）；主力流入是抄底失败（继续下跌）；背离持续时间过长（> 10天）表明趋势未改}

Rule 3 (板块集中流入 → 板块轮动):
IF {某板块3日主力净流入排名 <= 3 AND 板块流入强度 >= 5% AND 板块轮动速度 > 5}
THEN {未来3-5个交易日，该板块相对市场超额收益 >= 2%}
CONFIDENCE {0.60; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {申万一级行业、热门概念板块，流动性好的板块信号更强}
FAILURE_MODE {板块已大幅上涨（追高）；板块基本面转差；资金流入是短期炒作（不持续）；市场整体转弱}

Rule 4 (主力流出 + 融资余额高 → 调整风险):
IF {5日主力累计净流出 < 0 AND 融资余额占比 >= 10% AND 融资情绪 > 1.5}
THEN {未来3-5个交易日，价格面临调整压力，预期下跌 >= 2%}
CONFIDENCE {0.63; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，融资标的股票（可融资融券）}
FAILURE_MODE {主力流出是获利了结（健康调整）；融资盘坚定持有（不平仓）；市场整体向好（系统性支撑）}

### 触发/解除/无效化条件

- **触发监控**：
  - 主力净流入/流出 >= 1亿或流入强度 >= 5%（显著流向）
  - 5日累计主力净流入 >= 3亿（趋势性流向）
  - 资金-价格背离持续 >= 3天（背离信号）
  - 板块3日主力净流入排名 <= 3（板块集中）

- **解除监控**：
  - 主力净流入恢复正常（-0.5亿 ~ +0.5亿区间持续3天）
  - 背离消失（资金与价格同向持续3天）
  - 板块流入分散（单板块占比 < 10%持续3天）

- **无效化**：
  - 数据缺失或延迟 > 2天（节假日除外）
  - 个股停牌（无法交易）
  - 成交额过低（< 1000万，数据不可靠）
  - 市场异常波动（熔断、涨跌停超过50%个股）

### 阈值选择依据

- **1亿主力净流入**：约占中小盘股日成交额的5-10%，是显著流向
- **3%流入强度**：主力净流入占成交额3%以上，表明主力明显参与
- **5%板块流入强度**：板块主力净流入占板块成交额5%以上，表明板块受关注
- **10%融资余额占比**：融资余额占流通市值10%以上，是较高杠杆水平
- **3天背离**：连续3天资金-价格背离，是较强但非极端的信号

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 节假日：使用前一交易日数据，标注"节假日无数据"
  - 系统故障：使用东方财富网页数据作为备份，标注"备用数据源"
  - 个股停牌：从监控列表中剔除，标注"停牌无数据"

- **异常值处理**：
  - 主力净流入 > 10亿（小盘股）：检查是否数据错误或重大事件，标注"极端流入"
  - 流入强度 > 30%：检查是否计算错误，标注"极端强度"
  - 融资余额占比 > 30%：检查是否流通股本变化，标注"高杠杆"

### 降级策略

- **东方财富接口不稳定**：
  - 备用数据源1：同花顺资金流数据
  - 备用数据源2：Wind资金流数据（需付费）
  - 备用数据源3：使用成交量和价格推算（量价关系）
  - 降级标注："使用备用数据源，可能有差异"

- **融资融券数据缺失**：
  - 使用前一交易日数据（标注延迟）
  - 使用交易所官网数据（手动输入）
  - 降级标注："融资融券数据延迟1天"

- **历史数据不足**（< 252天）：
  - 使用可用历史计算百分位（标注样本期）
  - 使用固定阈值代替百分位（如1亿代替80百分位）
  - 降级标注："历史数据不足，阈值可能不准确"

## A股特殊注意

### 1. T+1交易制度影响

- **当日买入次日才能卖出**：主力资金当日流入后次日才能卖出，因此：
  - 当日大幅流入后，次日抛压较小（锁定效应）
  - 连续流入比单日流入更有持续性
  - 流出时可能集中在开盘（T日买入T+1日卖出）

### 2. 涨跌停限制影响

- **涨停板限制买入**：个股涨停时主力资金无法买入，导致：
  - 流入可能延后到次日（涨停打开后）
  - 涨停板上的封单不计入主力流入（无法成交）
  - 涨停股的资金流数据失真

- **跌停板限制卖出**：个股跌停时主力资金无法卖出，导致：
  - 流出可能延后到次日（跌停打开后）
  - 跌停板上的抛单不计入主力流出（无法成交）
  - 次日开盘可能集中抛售

### 3. 停牌影响

- **重大事项停牌**：个股停牌期间无法交易，导致：
  - 资金流数据为0（无交易）
  - 复牌后可能集中流入/流出
  - 需要从监控列表中剔除停牌股

### 4. 对倒与虚假流入

- **主力对倒**：主力在不同账户间对倒交易，制造虚假流入：
  - 主力流入但散户流出（对倒嫌疑）
  - 成交量放大但价格不涨（对倒嫌疑）
  - 需要结合换手率、价格变化综合判断

### 5. 数据口径差异

- **不同数据源口径不同**：东方财富、同花顺、Wind的资金流数据口径不同：
  - 大单标准不同（50万 vs 100万）
  - 主力定义不同（机构 vs 大单）
  - 需要统一数据源，避免混用

### 6. 盘后交易影响

- **盘后大宗交易**：大宗交易不计入资金流数据，导致：
  - 主力可能通过大宗交易买入/卖出（不影响资金流）
  - 需要结合大宗交易数据综合判断
  - 大宗交易通常有折价（5-10%）

### 7. 融资融券影响

- **融资买入**：融资买入计入主力流入，但有强平风险：
  - 融资余额高时（> 10%）：强平风险增加
  - 股价下跌时：融资盘可能被强平（集中卖出）
  - 需要监控融资余额和维持担保比例

### 8. 数据更新时间

- **T日晚间更新**：资金流数据在T日收盘后更新（通常19:00-20:00）：
  - 盘中无法获取实时数据（仅有盘口数据）
  - 日内分析需要使用盘口大单数据
  - 次日早盘前可获取前日完整数据

### 9. 板块分类差异

- **行业板块 vs 概念板块**：
  - 行业板块：申万一级/二级行业（稳定）
  - 概念板块：市场热点概念（变化快）
  - 概念板块更适合短期轮动分析

### 10. 散户行为特征

- **散户追涨杀跌**：散户往往在高位流入、低位流出：
  - 散户流入 + 主力流出 = 顶部信号
  - 散户流出 + 主力流入 = 底部信号
  - 需要区分主力和散户的资金流向

## 回测说明（最小化）

- **回测设计**：
  - 每日收盘后计算信号（T日晚间）
  - 次日开盘买入/卖出（T+1日）
  - 持有期：3日/5日/10日
  - 基准：个股前期走势、行业指数

- **性能指标**：
  - 信号胜率（信号后N日上涨概率）
  - 平均超额收益（信号后N日收益 - 基准收益）
  - 夏普比率、最大回撤

- **证伪条件**：
  - 信号胜率 <= 50%（不优于随机）
  - 平均超额收益 <= 0（不优于基准）
  - 夏普比率 <= 0.5（风险调整后收益不佳）

## 使用示例

### 示例1：主力持续流入

**输入**：个股A，2024-02-15收盘后
**数据**：
- 5日主力累计净流入：+3.5亿
- 5日涨跌幅：+8.2%
- 资金流入强度：4.5%
- 成交额：7.8亿/日
**输出**：
- 信号：主力持续流入 + 价格上涨（趋势延续）
- **结论**：主力资金持续流入，价格同步上涨，趋势较强，短期继续看多

### 示例2：资金-价格背离

**输入**：个股B，2024-03-20收盘后
**数据**：
- 5日主力累计净流入：+2.8亿
- 5日涨跌幅：-6.5%
- 持续背离天数：4天
- 调整幅度：-12%（从高点）
**输出**：
- 信号：主力流入 + 价格下跌（底部信号）
- **结论**：主力资金逆势流入，价格调整充分，可能是底部信号，关注反弹机会

### 示例3：板块集中流入

**输入**：新能源板块，2024-04-10收盘后
**数据**：
- 3日主力净流入排名：第2名
- 板块流入强度：6.8%
- 板块轮动速度：8（排名上升8位）
- 板块涨跌幅：+5.2%
**输出**：
- 信号：板块集中流入（板块轮动）
- **结论**：新能源板块资金集中流入，板块轮动加速，短期继续看好该板块

### 示例4：融资余额高 + 主力流出

**输入**：个股C，2024-05-15收盘后
**数据**：
- 5日主力累计净流出：-2.2亿
- 融资余额占比：12%
- 融资情绪：1.8（高位）
- 5日涨跌幅：-3.5%
**输出**：
- 信号：主力流出 + 融资余额高（调整风险）
- **结论**：主力资金流出，融资余额处于高位，存在强平风险，短期谨慎
