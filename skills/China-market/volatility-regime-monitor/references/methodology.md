# 方法论：波动率状态机（Risk-on / Risk-off）

本方法论用“波动率状态”来决定：**仓位上限、止损尺度、是否需要降低杠杆**。它不预测方向，只定义风险环境。

> 数据可以来自任何来源（第三方数据平台、开源行情等）。关键是：收益率序列频率一致（日/周），并明确是否年化。

---

## 1) 核心指标（建议）

### 1.1 已实现波动（Realized Vol）

常用定义（示意）：

- 日收益率：`r_t = ln(P_t / P_{t-1})`
- 近 N 日波动：`RV_N = std(r_{t-N+1..t})`
- 年化：`RV_N_annual = RV_N × sqrt(252)`

建议窗口：
- 短：20D（约1个月）
- 中：60D（约1个季度）
- 长：252D（约1年）

### 1.2 回撤与尾部

- 最大回撤（MDD）
- 下行偏差/半方差（仅负收益）
- 波动的波动（Vol-of-Vol）：例如 `std(RV_20D)`（用于“风险不稳定”提示）

### 1.3 ATR（若用 OHLC）

ATR 更贴近“实际区间波动”，适合做止损/仓位尺度（但必须写清单位与窗口）。

---

## 2) 状态划分（用分位数，不写死绝对阈值）

推荐做法：

- 用尽可能长的历史样本（例如近 3–5 年）计算 `RV_20D` 的分位数
- 划分三档（示例）：
  - 低波动：`RV_20D` < P33
  - 中波动：P33–P67
  - 高波动：> P67（或极端：> P90）

输出必须包含：
- 样本期
- 窗口 N
- 是否年化
- 当前分位数

---

## 3) 状态信号与解读（不预测方向）

### 3.1 波动突然放大（加速期）

含义：
- 事件冲击/情绪释放/趋势加速窗口

风险提示：
- 可能见顶也可能见底；必须结合方向、成交与资金验证。

### 3.2 波动持续收缩（压缩期）

含义：
- 市场进入“方向选择窗口”

用法：
- 把它当作“需要盯紧突破/破位”的提醒，而不是买卖信号。

### 3.3 极端波动（尾部风险）

当波动处于历史极端分位：
- 降低杠杆与单票仓位上限
- 强化流动性约束与止损纪律

---

## 4) 风控落地：仓位与止损（示例而非通用最优）

### 4.1 仓位上限（示意）

- 低波动：允许更高仓位上限（仍需考虑集中度/相关性）
- 高波动：降低仓位上限与单票暴露，避免被动止损

### 4.2 止损尺度（示意）

若用户希望用波动做止损，可给“尺度示例”：

- `StopDistance ≈ k × ATR`（k 常用 1.5–3，视策略而定）
- 或 `StopDistance ≈ k × RV_20D × Price`

必须提示：
- 波动不是方向；止损尺度应与“可交易性/滑点”共同评估。

---

## 5) 交叉验证（建议）

- 杠杆拥挤：`$margin-risk-monitor`
- 流动性与冲击成本：`$liquidity-impact-estimator`
- 资金与背离：`$fund-flow-monitor`
