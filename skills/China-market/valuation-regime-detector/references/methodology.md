# 方法论：估值制度检测器（A股）

本技能用于**检测A股市场的估值制度（高估、合理、低估），识别估值拐点**。估值是判断市场位置和投资价值的核心指标。

## 数据口径

### 数据源与字段映射

估值制度检测需要以下数据：
- **估值数据**：AKShare (`stock_zh_index_daily_em`)
  - 市盈率PE、市净率PB、股息率
  - 日频数据，实时更新
- **盈利数据**：AKShare (`stock_financial_report_sina`)
  - 净利润、ROE、盈利增速
  - 季度数据，财报发布后更新
- **历史估值数据**：AKShare历史数据
  - 历史PE、PB分位数
  - 日频数据，历史回溯

关键字段：
- `PE = 总市值 / 归母净利润`
- `PB = 总市值 / 净资产`
- `估值分位数 = rank(PE) / 历史天数`

### 时间窗口与频率

- **日频数据**：PE、PB、股息率
- **历史回溯**：10年历史数据
- **分位数计算**：滚动10年分位数

## 核心指标

### 指标列表与计算公式

1. **估值水平指标**：
   - `PE = 总市值 / 归母净利润` (倍)
   - `PB = 总市值 / 净资产` (倍)
   - `股息率 = 每股分红 / 股价 × 100%` (%)
   - `ERP = 1/PE - 10年期国债收益率` (%)

2. **估值分位数指标**：
   - `PE分位数 = rank(PE) / 历史天数 × 100%` (%)
   - `PB分位数 = rank(PB) / 历史天数 × 100%` (%)
   - `综合估值分位数 = (PE分位数 + PB分位数) / 2` (%)

3. **估值制度指标**：
   - `估值制度 = f(PE分位数, PB分位数, 盈利增速)` (高估/合理/低估)
   - `估值偏离度 = (当前PE - 历史中位数PE) / 历史中位数PE × 100%` (%)

4. **盈利匹配指标**：
   - `PEG = PE / 盈利增速` (倍)
   - `盈利支撑度 = 盈利增速 / PE增速` (倍)

5. **估值拐点指标**：
   - `估值趋势 = sign(PE变化率)` (+1/-1)
   - `估值拐点 = 1{估值趋势反转}` (0/1)

### 标准化方法

- 使用**历史分位数**评估估值水平
- 使用**PEG**评估估值与盈利匹配度
- 使用**ERP**评估股债性价比

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (低估值 + 盈利改善 → 估值修复):
IF {PE分位数 <= 30% AND 盈利增速 >= 10% AND PEG < 1}
THEN {未来6-12个月，估值修复，市场上涨概率 >= 68%}
CONFIDENCE {0.68; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场，估值底部}
FAILURE_MODE {盈利不及预期；风险偏好下降；外部冲击}

Rule 2 (高估值 + 盈利放缓 → 估值压缩):
IF {PE分位数 >= 70% AND 盈利增速 < 5% AND PEG > 2}
THEN {未来3-6个月，估值压缩，市场回调概率 >= 65%}
CONFIDENCE {0.65; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场，估值顶部}
FAILURE_MODE {盈利超预期；流动性宽松；风险偏好提升}

Rule 3 (估值拐点 + 政策转向 → 趋势反转):
IF {估值趋势反转 AND 政策基调转向 AND 估值分位数处于极端（<20%或>80%）}
THEN {未来1-3个月，市场趋势反转概率 >= 62%}
CONFIDENCE {0.62; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场，估值拐点}
FAILURE_MODE {政策执行不及预期；市场惯性延续；外部环境恶化}

Rule 4 (ERP扩大 + 利率下行 → 股债性价比提升):
IF {ERP >= 4% AND 10年期国债收益率下降 >= 20bp}
THEN {未来3-6个月，股市相对债市吸引力提升，资金流入股市}
CONFIDENCE {0.60; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场，股债配置}
FAILURE_MODE {经济下行压力大；风险偏好下降；债市收益率反弹}

### 触发/解除/无效化条件

- **触发监控**：
  - PE分位数 <= 30%或 >= 70%
  - 估值趋势反转
  - ERP >= 4%或 <= 2%

- **解除监控**：
  - 估值回归合理区间（30-70%分位）
  - 估值趋势稳定
  - ERP回归正常

- **无效化**：
  - 盈利数据大幅调整
  - 估值口径变化
  - 市场制度变化

### 阈值选择依据

- **30% PE分位数**：PE分位数 <= 30%属于低估
- **70% PE分位数**：PE分位数 >= 70%属于高估
- **1倍PEG**：PEG < 1说明估值与盈利匹配良好
- **2倍PEG**：PEG > 2说明估值过高
- **4% ERP**：ERP >= 4%说明股市相对债市有吸引力

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 盈利数据缺失：使用预测数据，标注"使用预测"
  - 历史数据不足：缩短回溯期，标注"历史数据不足"

- **异常值处理**：
  - PE < 0（亏损）：使用PB代替，标注"使用PB"
  - PE > 100：检查是否微利或数据错误

### 降级策略

- **历史数据不足**（< 5年）：
  - 使用可用数据计算分位数
  - 降级标注："历史数据不足，分位数可能有偏"

- **盈利数据滞后**（> 3个月）：
  - 使用预测数据
  - 降级标注："使用盈利预测，存在不确定性"

## A股特殊注意

### 1. 估值中枢变化

- **估值中枢下移**：A股估值中枢长期下移
- **需要动态调整**：分位数计算需要考虑估值中枢变化

### 2. 盈利波动大

- **盈利周期性强**：A股盈利周期性强，波动大
- **需要平滑处理**：使用TTM或平滑盈利

### 3. 板块分化

- **板块估值分化**：不同板块估值差异大
- **需要分板块分析**：除全市场估值外，需分析板块估值

### 4. 政策影响

- **政策影响估值**：政策对估值影响大
- **需要考虑政策**：估值分析需考虑政策环境

### 5. 流动性影响

- **流动性影响估值**：流动性宽松时估值扩张
- **需要考虑流动性**：估值分析需考虑流动性环境

### 6. 风险偏好

- **风险偏好影响估值**：风险偏好高时估值扩张
- **需要考虑风险偏好**：估值分析需考虑市场情绪

### 7. 盈利质量

- **盈利质量差异**：不同公司盈利质量差异大
- **需要调整盈利**：剔除非经常性损益

### 8. 估值陷阱

- **低估值陷阱**：部分低估值股票是价值陷阱
- **需要结合基本面**：估值分析需结合基本面

### 9. 成长溢价

- **成长股估值高**：成长股估值高于价值股
- **需要使用PEG**：成长股使用PEG评估

### 10. 国际对比

- **A股估值偏低**：A股估值低于国际市场
- **需要国际对比**：估值分析需国际对比

## 回测说明（最小化）

- **回测设计**：
  - 计算历史估值分位数
  - 识别估值极端区域
  - 统计估值信号有效性

- **性能指标**：
  - 估值信号准确率
  - 估值信号后收益
  - 估值拐点识别准确率

- **证伪条件**：
  - 信号准确率 < 55%
  - 估值信号后收益不显著

## 使用示例

### 示例1：低估值修复

**输入**：2024-03-15估值数据
**数据**：
- PE分位数：25%
- 盈利增速：+12%
- PEG：0.8
**输出**：
- 信号：低估值 + 盈利改善（估值修复）
- **结论**：估值处于底部，盈利改善，未来6-12个月估值修复

### 示例2：高估值压缩

**输入**：2024-04-20估值数据
**数据**：
- PE分位数：75%
- 盈利增速：+3%
- PEG：2.5
**输出**：
- 信号：高估值 + 盈利放缓（估值压缩）
- **结论**：估值偏高，盈利放缓，未来3-6个月估值压缩风险

### 示例3：估值拐点

**输入**：2024-05-10估值数据
**数据**：
- 估值趋势：反转（由下降转上升）
- 政策基调：转向宽松
- PE分位数：18%
**输出**：
- 信号：估值拐点 + 政策转向（趋势反转）
- **结论**：估值拐点出现，政策转向，市场趋势可能反转

### 示例4：股债性价比

**输入**：2024-06-15估值数据
**数据**：
- ERP：4.5%
- 10年期国债收益率：下降30bp至2.3%
- PE分位数：35%
**输出**：
- 信号：ERP扩大 + 利率下行（股债性价比提升）
- **结论**：股市相对债市吸引力提升，资金可能流入股市
