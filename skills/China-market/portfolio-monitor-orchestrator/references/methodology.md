# 方法论：组合监控编排器（A股）

本技能用于**编排和协调多个监控技能，提供投资组合的全面监控和风险预警**。组合监控是投资管理的核心环节。

## 数据口径

### 数据源与字段映射

组合监控编排需要以下数据：
- **持仓数据**：用户输入或券商接口
  - 股票代码、持仓数量、成本价、当前价
  - 实时数据，交易后更新
- **市场数据**：AKShare (`stock_zh_a_hist`)
  - 股价、涨跌幅、成交量
  - 日频数据，实时更新
- **风险数据**：各监控技能输出
  - 解禁风险、质押风险、ST风险等
  - 实时数据，各技能更新

关键字段：
- `持仓市值 = 持仓数量 × 当前价`
- `持仓权重 = 持仓市值 / 组合总市值`
- `盈亏 = (当前价 - 成本价) × 持仓数量`

### 时间窗口与频率

- **实时监控**：盘中实时监控
- **日频汇总**：每日收盘后汇总
- **周频报告**：每周生成监控报告

## 核心指标

### 指标列表与计算公式

1. **组合表现指标**：
   - `组合市值 = Σ(持仓市值)` (元)
   - `组合收益率 = (组合市值 - 组合成本) / 组合成本 × 100%` (%)
   - `组合日收益率 = (今日市值 - 昨日市值) / 昨日市值 × 100%` (%)
   - `组合年化收益率 = (1 + 组合收益率)^(365/持有天数) - 1` (%)

2. **风险指标**：
   - `组合波动率 = std(组合日收益率) × √252` (%)
   - `组合最大回撤 = max(组合累计收益峰值 - 当前累计收益)` (%)
   - `组合夏普比率 = (组合年化收益率 - 无风险利率) / 组合波动率`
   - `组合Beta = cov(组合收益, 市场收益) / var(市场收益)`

3. **持仓集中度指标**：
   - `持仓集中度 = Σ(持仓权重^2)` (0-1)
   - `前十大持仓占比 = Σ(前十大持仓权重)` (%)
   - `单一持仓最大权重 = max(持仓权重)` (%)
   - `行业集中度 = Σ(行业权重^2)` (0-1)

4. **风险预警指标**：
   - `解禁风险股数 = count(解禁风险 = 高)` (只)
   - `质押风险股数 = count(质押风险 = 高)` (只)
   - `ST风险股数 = count(ST风险 = 高)` (只)
   - `综合风险评分 = f(各类风险)` (0-100)

5. **归因指标**：
   - `个股贡献 = 持仓权重 × 个股收益率` (%)
   - `行业贡献 = 行业权重 × 行业收益率` (%)
   - `选股贡献 = Σ(持仓权重 × (个股收益 - 行业收益))` (%)
   - `配置贡献 = Σ((行业权重 - 基准行业权重) × 行业收益)` (%)

### 标准化方法

- 使用**风险调整收益**评估组合表现
- 使用**集中度指标**评估分散化程度
- 使用**归因分析**识别收益来源

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (高集中度 + 单一风险 → 分散化不足):
IF {持仓集中度 >= 0.3 AND 单一持仓最大权重 >= 20% AND 风险股数 >= 2}
THEN {组合风险集中，建议降低集中度，分散持仓}
CONFIDENCE {0.70; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，集中持仓}
FAILURE_MODE {集中持仓股票表现好；风险未实现；市场整体向好}

Rule 2 (多重风险预警 → 降低仓位):
IF {解禁风险股数 >= 2 AND 质押风险股数 >= 1 AND ST风险股数 >= 1}
THEN {组合多重风险，建议降低仓位或卖出风险股}
CONFIDENCE {0.75; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，风险预警}
FAILURE_MODE {风险未实现；公司及时应对；市场整体向好}

Rule 3 (回撤过大 + 波动率上升 → 风险控制):
IF {组合最大回撤 >= 20% AND 组合波动率 >= 历史80%分位}
THEN {组合风险过大，建议降低仓位或调整持仓}
CONFIDENCE {0.68; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，风险控制}
FAILURE_MODE {市场快速反弹；组合调整及时；风险偏好提升}

Rule 4 (夏普比率低 + 跑输基准 → 策略调整):
IF {组合夏普比率 < 0.5 AND 组合收益 < 基准收益 - 5%}
THEN {组合表现差，建议调整策略或持仓}
CONFIDENCE {0.65; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，策略调整}
FAILURE_MODE {市场环境不利（熊市）；策略风格不适应；短期波动}

### 触发/解除/无效化条件

- **触发监控**：
  - 持仓集中度 >= 0.3
  - 风险股数 >= 2
  - 组合最大回撤 >= 20%
  - 夏普比率 < 0.5

- **解除监控**：
  - 集中度降低
  - 风险消除
  - 回撤收窄
  - 夏普比率提升

- **无效化**：
  - 组合清盘
  - 策略调整
  - 市场异常

### 阈值选择依据

- **0.3持仓集中度**：持仓集中度 >= 0.3属于高集中度
- **20%单一持仓**：单一持仓 >= 20%属于过度集中
- **20%最大回撤**：最大回撤 >= 20%属于风险过大
- **0.5夏普比率**：夏普比率 < 0.5属于风险调整后收益差
- **2只风险股**：风险股数 >= 2属于多重风险

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 持仓数据缺失：使用上一交易日数据，标注"数据滞后"
  - 风险数据缺失：使用历史数据，标注"风险数据滞后"

- **异常值处理**：
  - 持仓权重 > 50%：检查是否数据错误
  - 组合收益率 > 100%：检查是否计算错误

### 降级策略

- **风险数据不完整**：
  - 使用部分风险数据
  - 降级标注："风险数据不完整"

- **实时数据不可用**：
  - 使用收盘数据
  - 降级标注："使用收盘数据，实时性差"

## A股特殊注意

### 1. T+1交易

- **T+1限制调整**：T+1限制组合调整速度
- **需要提前判断**：需要提前判断风险

### 2. 涨跌停影响

- **涨跌停影响调整**：涨跌停时无法调整持仓
- **需要分批调整**：分批调整降低冲击

### 3. 停牌影响

- **停牌无法交易**：停牌股票无法卖出
- **需要调整权重**：停牌时调整权重计算

### 4. 流动性约束

- **小盘股流动性差**：小盘股调整成本高
- **需要考虑流动性**：调整时考虑流动性

### 5. 交易成本

- **交易成本高**：频繁调整成本高
- **需要控制频率**：控制调整频率

### 6. 风险叠加

- **多重风险叠加**：A股风险叠加常见
- **需要综合评估**：综合评估多重风险

### 7. 政策影响

- **政策影响组合**：政策对组合影响大
- **需要关注政策**：关注政策变化

### 8. 市场风格

- **风格轮动快**：A股风格轮动快
- **需要动态调整**：动态调整组合风格

### 9. 行业轮动

- **行业轮动快**：A股行业轮动快
- **需要行业配置**：关注行业配置

### 10. 监控频率

- **需要实时监控**：A股波动大，需要实时监控
- **需要及时预警**：及时预警风险

## 回测说明（最小化）

- **回测设计**：
  - 模拟组合监控
  - 验证风险预警有效性
  - 统计调整效果

- **性能指标**：
  - 风险预警准确率
  - 调整后收益改善
  - 风险控制效果

- **证伪条件**：
  - 预警准确率 < 60%
  - 调整后收益未改善

## 使用示例

### 示例1：高集中度预警

**输入**：组合A，2024-03-15
**数据**：
- 持仓集中度：0.35
- 单一持仓最大权重：25%
- 风险股数：3只
**输出**：
- 信号：高集中度（分散化不足）
- **结论**：组合风险集中，建议降低集中度

### 示例2：多重风险预警

**输入**：组合B，2024-04-20
**数据**：
- 解禁风险股数：2只
- 质押风险股数：1只
- ST风险股数：1只
**输出**：
- 信号：多重风险预警（降低仓位）
- **结论**：组合多重风险，建议降低仓位或卖出风险股

### 示例3：回撤过大

**输入**：组合C，2024-05-10
**数据**：
- 组合最大回撤：22%
- 组合波动率：历史85%分位
- 组合收益率：-15%
**输出**：
- 信号：回撤过大（风险控制）
- **结论**：组合风险过大，建议降低仓位或调整持仓

### 示例4：策略调整

**输入**：组合D，2024-06-15
**数据**：
- 组合夏普比率：0.3
- 组合收益：-8%（基准-2%）
- 跑输基准：-6%
**输出**：
- 信号：夏普比率低（策略调整）
- **结论**：组合表现差，建议调整策略或持仓
