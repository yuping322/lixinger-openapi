# 方法论：日内微观结构分析器（A股）

本技能用于**分析A股日内交易的微观结构，识别日内交易机会和风险**。微观结构分析是短线交易和高频交易的基础。

## 数据口径

### 数据源与字段映射

日内微观结构分析需要以下数据：
- **分钟行情数据**：AKShare (`stock_zh_a_hist_min_em`)
  - 分钟K线、成交量、成交额
  - 分钟频数据，实时更新
- **逐笔成交数据**：AKShare (`stock_zh_a_tick_tx`)
  - 逐笔成交价格、数量、方向
  - 实时数据
- **买卖盘数据**：AKShare (`stock_bid_ask_em`)
  - 五档买卖盘、挂单量
  - 实时数据
- **大单数据**：AKShare (`stock_individual_fund_flow_rank`)
  - 大单流入流出、主力资金
  - 实时数据

关键字段：
- `买卖价差 = 卖一价 - 买一价`
- `订单失衡 = (买盘量 - 卖盘量) / (买盘量 + 卖盘量)`
- `成交方向 = 主动买入或主动卖出`

### 时间窗口与频率

- **分钟频数据**：1分钟、5分钟K线
- **实时数据**：逐笔成交、买卖盘
- **日内时段**：开盘、午盘、尾盘

## 核心指标

### 指标列表与计算公式

1. **价格指标**：
   - `分钟涨跌幅 = (当前价 - 上一分钟价) / 上一分钟价 × 100%` (%)
   - `日内振幅 = (最高价 - 最低价) / 开盘价 × 100%` (%)
   - `距涨跌停距离 = (涨跌停价 - 当前价) / 当前价 × 100%` (%)

2. **成交量指标**：
   - `分钟成交量` (手)
   - `成交量比 = 当前分钟成交量 / 平均分钟成交量` (倍)
   - `累计成交量 = Σ(分钟成交量)` (手)
   - `换手率 = 累计成交量 / 流通股本 × 100%` (%)

3. **买卖盘指标**：
   - `买卖价差 = 卖一价 - 买一价` (元)
   - `买卖价差率 = 买卖价差 / 中间价 × 100%` (%)
   - `订单失衡 = (买盘量 - 卖盘量) / (买盘量 + 卖盘量)` (-1到+1)
   - `买卖盘比 = 买盘量 / 卖盘量` (倍)

4. **资金流向指标**：
   - `主动买入额 = Σ(主动买入成交额)` (元)
   - `主动卖出额 = Σ(主动卖出成交额)` (元)
   - `净流入 = 主动买入额 - 主动卖出额` (元)
   - `大单净流入 = 大单买入 - 大单卖出` (元)

5. **微观结构指标**：
   - `有效价差 = 2 × |成交价 - 中间价|` (元)
   - `价格冲击 = Δ价格 / 成交量` (元/手)
   - `订单流毒性 = f(价格冲击, 订单失衡)` (0-1)
   - `市场深度 = 五档买卖盘总量` (手)

### 标准化方法

- 使用**订单失衡**评估买卖力量对比
- 使用**价格冲击**评估流动性
- 使用**资金流向**识别主力行为

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (开盘大单流入 + 订单失衡 → 日内上涨):
IF {开盘30分钟大单净流入 >= 5000万 AND 订单失衡 >= 0.3 AND 成交量放大 >= 2倍}
THEN {日内上涨概率 >= 65%，涨幅 >= 3%}
CONFIDENCE {0.65; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，日内交易}
FAILURE_MODE {大单流入后流出；市场整体转弱；个股利好出尽}

Rule 2 (尾盘拉升 + 成交量萎缩 → 次日回调):
IF {尾盘30分钟涨幅 >= 3% AND 成交量 < 日均成交量 × 0.5 AND 买卖价差扩大}
THEN {次日开盘回调概率 >= 60%，回调幅度 >= 2%}
CONFIDENCE {0.60; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，尾盘拉升}
FAILURE_MODE {尾盘拉升持续（次日高开）；市场整体向好；个股利好持续}

Rule 3 (订单失衡反转 + 价格冲击 → 短期反转):
IF {订单失衡从+0.5反转至-0.5 AND 价格冲击 >= 历史80%分位}
THEN {未来5-15分钟，价格反转概率 >= 62%}
CONFIDENCE {0.62; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，日内反转}
FAILURE_MODE {订单失衡继续恶化；市场趋势延续；流动性枯竭}

Rule 4 (买卖价差扩大 + 市场深度下降 → 流动性风险):
IF {买卖价差率 >= 0.5% AND 市场深度 < 平均深度 × 0.5}
THEN {流动性风险上升，交易成本增加，建议谨慎交易}
CONFIDENCE {0.70; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股个股，流动性风险}
FAILURE_MODE {流动性快速恢复；市场深度回升；买卖价差收窄}

### 触发/解除/无效化条件

- **触发监控**：
  - 大单净流入 >= 5000万
  - 订单失衡 >= 0.3或 <= -0.3
  - 买卖价差率 >= 0.5%
  - 成交量异常（>= 2倍或 <= 0.5倍）

- **解除监控**：
  - 日内交易结束（收盘）
  - 订单失衡回归正常
  - 流动性恢复

- **无效化**：
  - 停牌
  - 涨跌停（流动性枯竭）
  - 市场异常

### 阈值选择依据

- **5000万大单**：大单净流入 >= 5000万属于显著流入
- **0.3订单失衡**：订单失衡 >= 0.3说明买盘占优
- **2倍成交量**：成交量 >= 2倍平均说明放量
- **0.5%买卖价差率**：买卖价差率 >= 0.5%属于流动性差
- **3%尾盘涨幅**：尾盘涨幅 >= 3%属于明显拉升

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 分钟数据缺失：使用前后数据插值，标注"数据插值"
  - 逐笔数据缺失：使用分钟数据代替，标注"使用分钟数据"

- **异常值处理**：
  - 订单失衡 > 0.9：检查是否涨跌停或极端情况
  - 买卖价差 > 5%：检查是否流动性枯竭

### 降级策略

- **实时数据不可用**：
  - 使用分钟数据
  - 降级标注："使用分钟数据，精度降低"

- **流动性极差**（买卖价差 > 2%）：
  - 暂停分析
  - 降级标注："流动性极差，分析失效"

## A股特殊注意

### 1. T+1交易

- **无法日内T+0**：A股无法日内T+0交易
- **日内分析用于次日**：日内分析主要用于次日开盘

### 2. 涨跌停影响

- **涨跌停流动性枯竭**：涨跌停时流动性枯竭
- **微观结构失效**：涨跌停时微观结构分析失效

### 3. 停牌影响

- **临时停牌**：盘中临时停牌影响分析
- **需要剔除停牌**：停牌期间数据无效

### 4. 集合竞价

- **开盘集合竞价**：9:15-9:25集合竞价
- **尾盘集合竞价**：14:57-15:00集合竞价
- **需要特殊处理**：集合竞价期间微观结构不同

### 5. 午间休市

- **午间休市**：11:30-13:00休市
- **需要分段分析**：上午和下午分段分析

### 6. 大单定义

- **大单标准**：通常 >= 50万元为大单
- **需要动态调整**：不同市值股票大单标准不同

### 7. 主力行为

- **主力拉升**：主力拉升常见于开盘和尾盘
- **主力出货**：主力出货常见于午盘
- **需要识别主力**：识别主力行为是关键

### 8. 散户行为

- **散户追涨杀跌**：散户日内追涨杀跌明显
- **需要逆向思考**：散户行为可作为反向指标

### 9. 高频交易

- **高频交易增多**：A股高频交易增多
- **微观结构复杂**：高频交易使微观结构更复杂

### 10. 数据延迟

- **数据延迟**：实时数据有延迟（1-3秒）
- **需要考虑延迟**：分析时考虑数据延迟

## 回测说明（最小化）

- **回测设计**：
  - 模拟日内交易
  - 验证微观结构信号
  - 统计信号有效性

- **性能指标**：
  - 信号准确率
  - 日内收益
  - 交易成本

- **证伪条件**：
  - 信号准确率 < 55%
  - 日内收益 < 交易成本

## 使用示例

### 示例1：开盘大单流入

**输入**：个股A，2024-03-15开盘
**数据**：
- 开盘30分钟大单净流入：6000万
- 订单失衡：+0.35
- 成交量：2.5倍平均
**输出**：
- 信号：开盘大单流入（日内上涨）
- **结论**：开盘大单流入，订单失衡，日内上涨概率高

### 示例2：尾盘拉升

**输入**：个股B，2024-04-20尾盘
**数据**：
- 尾盘30分钟涨幅：+3.5%
- 成交量：0.4倍日均
- 买卖价差：扩大至0.6%
**输出**：
- 信号：尾盘拉升（次日回调）
- **结论**：尾盘缩量拉升，次日开盘回调概率高

### 示例3：订单失衡反转

**输入**：个股C，2024-05-10盘中
**数据**：
- 订单失衡：从+0.5反转至-0.5
- 价格冲击：历史85%分位
- 时间：10:30
**输出**：
- 信号：订单失衡反转（短期反转）
- **结论**：订单失衡反转，未来5-15分钟价格可能反转

### 示例4：流动性风险

**输入**：个股D，2024-06-15盘中
**数据**：
- 买卖价差率：0.6%
- 市场深度：0.4倍平均
- 成交量：萎缩
**输出**：
- 信号：流动性风险
- **结论**：买卖价差扩大，市场深度下降，流动性风险上升
