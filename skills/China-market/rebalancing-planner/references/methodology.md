# 方法论：再平衡规划器（A股）

本技能用于**规划投资组合的再平衡策略，维持目标资产配置，控制风险暴露**。再平衡是组合管理的核心环节，通过定期调整恢复目标权重，实现"低买高卖"。

## 数据口径

### 数据源与字段映射

再平衡规划需要以下数据：
- **组合持仓数据**：用户输入或券商接口
  - 股票代码、持仓数量、成本价、当前价
  - 实时数据，交易后更新
- **股价数据**：AKShare (`stock_zh_a_hist`)
  - 当前价格、涨跌幅、成交量
  - 日频数据，实时更新
- **目标配置**：用户设定
  - 目标权重、风险预算、约束条件
  - 手动设定，定期更新
- **交易成本**：券商费率
  - 佣金、印花税、过户费
  - 固定参数

关键字段：
- `当前权重 = 持仓市值 / 组合总市值`
- `目标权重`：用户设定的目标配置
- `偏离度 = |当前权重 - 目标权重|`
- `再平衡交易量 = (目标市值 - 当前市值) / 当前价格`

### 时间窗口与频率

- **日频监控**：每日监控组合偏离度
- **周频再平衡**：战术组合每周再平衡
- **月频再平衡**：战略组合每月再平衡
- **季度再平衡**：核心组合每季度再平衡
- **阈值触发**：偏离度超过阈值时触发再平衡

## 核心指标

### 指标列表与计算公式

1. **权重指标**：
   - `当前权重 = 持仓市值 / 组合总市值 × 100%` (%)
   - `目标权重`：用户设定 (%)
   - `权重偏离 = 当前权重 - 目标权重` (%)
   - `偏离度 = |权重偏离|` (%)

2. **再平衡指标**：
   - `再平衡需求 = 目标市值 - 当前市值` (元)
   - `再平衡比例 = 再平衡需求 / 当前市值 × 100%` (%)
   - `买入金额 = max(0, 再平衡需求)` (元)
   - `卖出金额 = max(0, -再平衡需求)` (元)

3. **成本指标**：
   - `交易成本 = 交易金额 × (佣金率 + 印花税率 + 过户费率)` (元)
   - `冲击成本 = 交易金额 × 冲击成本率` (元)
   - `总成本 = 交易成本 + 冲击成本` (元)
   - `成本占比 = 总成本 / 组合总市值 × 100%` (%)

4. **风险指标**：
   - `组合波动率 = √(w^T Σ w)` (%)
   - `风险贡献 = 权重 × β × 组合波动率` (%)
   - `风险集中度 = max(风险贡献) / Σ(风险贡献)` (%)
   - `跟踪误差 = std(组合收益率 - 基准收益率) × √252` (%)

5. **效率指标**：
   - `再平衡频率 = 再平衡次数 / 年` (次/年)
   - `平均偏离度 = mean(偏离度)` (%)
   - `最大偏离度 = max(偏离度)` (%)
   - `再平衡效率 = 再平衡收益 / 再平衡成本` (倍)

### 标准化方法

- 使用**偏离度阈值**触发再平衡
- 使用**交易成本**评估再平衡效率
- 使用**风险贡献**控制风险暴露
- 使用**优化算法**（二次规划）最小化成本

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (定期再平衡 → 长期超额收益):
IF {再平衡频率 = 每季度 AND 偏离度阈值 = 5% AND 交易成本 < 0.5%}
THEN {未来3-5年，再平衡策略年化超额收益 >= 1.5%}
CONFIDENCE {0.62; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，宽基指数或多资产组合}
FAILURE_MODE {市场单边上涨（再平衡卖出强势资产）；交易成本过高（侵蚀收益）；市场波动率低（再平衡机会少）}

Rule 2 (阈值触发再平衡 > 定期再平衡):
IF {偏离度阈值 = 10% AND 交易成本 < 0.3%}
THEN {相比定期再平衡，阈值触发策略交易次数减少30%，成本降低，收益相当}
CONFIDENCE {0.65; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，适合低成本交易环境}
FAILURE_MODE {市场波动大（频繁触发）；阈值设置不当（过于频繁或过于稀疏）}

Rule 3 (风险平价再平衡 → 降低波动):
IF {再平衡目标 = 风险平价（各资产风险贡献相等）AND 再平衡频率 = 每月}
THEN {组合波动率降低20%，夏普比率提升15%}
CONFIDENCE {0.60; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股多资产组合，适合风险厌恶投资者}
FAILURE_MODE {低波动资产收益低（拖累收益）；风险估计不准（风险平价失效）；市场制度变化（相关性突变）}

Rule 4 (税收优化再平衡 → 提升税后收益):
IF {持股期限 >= 1年（免红利税）AND 再平衡时优先卖出亏损股（税损收割）}
THEN {税后收益提升0.5-1%/年}
CONFIDENCE {0.58; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股组合，适合长期投资者}
FAILURE_MODE {亏损股继续下跌（卖出后踏空反弹）；税收政策变化；组合无亏损股（无税损可收割）}

### 触发/解除/无效化条件

- **触发再平衡**：
  - 定期触发：每周/月/季度固定时间
  - 阈值触发：偏离度 >= 5%或10%
  - 风险触发：风险集中度 >= 40%
  - 事件触发：市场大幅波动、政策变化

- **解除再平衡**：
  - 再平衡完成（偏离度 < 阈值）
  - 市场异常（涨跌停、停牌）
  - 成本过高（交易成本 > 预期收益）

- **无效化**：
  - 目标配置调整（重新设定目标）
  - 组合清盘或大幅调整
  - 市场异常波动（熔断、系统性风险）

### 阈值选择依据

- **5%偏离度**：偏离度 >= 5%时再平衡，平衡频率和成本
- **10%偏离度**：偏离度 >= 10%时再平衡，降低频率和成本
- **0.5%交易成本**：交易成本 < 0.5%时再平衡有效
- **40%风险集中度**：风险集中度 >= 40%说明风险过于集中
- **每季度频率**：每季度再平衡是常见的平衡点

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 持仓数据缺失：使用上一交易日数据，标注"数据滞后"
  - 股价数据缺失：使用前后交易日数据插值，标注"数据插值"
  - 目标配置缺失：使用等权重配置，标注"使用默认配置"

- **异常值处理**：
  - 偏离度 > 50%：检查是否股价异常或持仓错误
  - 交易成本 > 5%：检查是否计算错误或流动性差
  - 再平衡金额 > 组合市值：检查是否目标配置错误

### 降级策略

- **流动性不足**（日均成交额 < 5000万）：
  - 延长再平衡周期
  - 分批交易降低冲击成本
  - 降级标注："流动性不足，分批再平衡"

- **交易成本过高**（> 1%）：
  - 提高偏离度阈值（如从5%提高到10%）
  - 降低再平衡频率
  - 降级标注："交易成本高，降低再平衡频率"

- **市场异常波动**（波动率 > 历史80%分位）：
  - 暂停再平衡
  - 等待市场稳定
  - 降级标注："市场异常波动，暂停再平衡"

## A股特殊注意

### 1. T+1交易制度影响

- **再平衡需要2天**：卖出T日，买入T+1日
- **隔夜风险**：T+1导致隔夜风险，影响再平衡效果
- **需要预留现金**：预留现金应对T+1限制

### 2. 涨跌停限制影响

- **涨跌停无法交易**：涨跌停时无法完成再平衡
- **需要分批交易**：涨跌停时分批交易
- **偏离度可能扩大**：涨跌停导致偏离度扩大

### 3. 停牌影响

- **停牌无法交易**：停牌股票无法卖出
- **需要调整目标**：停牌时调整目标配置
- **复牌后补平衡**：复牌后补充再平衡

### 4. 交易成本

- **佣金**：0.02%-0.03%（双向）
- **印花税**：0.1%（卖出单向）
- **过户费**：0.001%（双向）
- **总成本**：约0.15%（单次再平衡）
- **需要控制频率**：交易成本影响再平衡效率

### 5. 税收影响

- **红利税**：持股1个月内20%，1个月-1年10%，1年以上免税
- **资本利得税**：A股暂无资本利得税
- **需要考虑持股期限**：长期持股享受税收优惠
- **税损收割**：卖出亏损股降低税负

### 6. 流动性约束

- **小盘股流动性差**：小盘股日均成交额低，冲击成本高
- **大盘股流动性好**：大盘股日均成交额高，冲击成本低
- **需要分批交易**：大额交易分批进行

### 7. 市场波动

- **A股波动大**：A股波动率高于成熟市场
- **再平衡机会多**：波动大导致偏离度大，再平衡机会多
- **需要控制频率**：过于频繁再平衡成本高

### 8. 政策影响

- **政策市**：政策对A股影响大
- **政策变化导致偏离**：政策变化导致板块轮动，偏离度扩大
- **需要灵活调整**：政策变化时灵活调整目标配置

### 9. 行业轮动

- **行业轮动快**：A股行业轮动快
- **偏离度扩大快**：行业轮动导致偏离度快速扩大
- **需要动态调整**：行业轮动时动态调整目标配置

### 10. 散户行为

- **散户追涨杀跌**：散户情绪化交易
- **再平衡逆向操作**：再平衡是逆向操作（卖涨买跌）
- **需要纪律性**：再平衡需要纪律性，克服情绪

## 回测说明（最小化）

- **回测设计**：
  - 构建组合（如60%股票 + 40%债券）
  - 设定再平衡策略（定期或阈值触发）
  - 计算再平衡收益和成本

- **性能指标**：
  - 年化收益率
  - 夏普比率
  - 最大回撤
  - 再平衡超额收益

- **证伪条件**：
  - 再平衡收益 < 再平衡成本（无效策略）
  - 夏普比率 < 不再平衡策略（风险调整后收益差）

## 使用示例

### 示例1：定期再平衡

**输入**：组合配置60%股票 + 40%债券，每季度再平衡
**数据**：
- 当前权重：股票70%，债券30%
- 偏离度：股票+10%，债券-10%
- 交易成本：0.4%
**输出**：
- 再平衡方案：卖出10%股票，买入10%债券
- **结论**：定期再平衡，长期年化超额收益 >= 1.5%

### 示例2：阈值触发再平衡

**输入**：组合配置，偏离度阈值10%
**数据**：
- 当前权重：股票A 35%（目标30%），股票B 25%（目标30%）
- 偏离度：股票A +5%，股票B -5%
- 阈值：10%
**输出**：
- 再平衡方案：不触发再平衡（偏离度 < 10%）
- **结论**：阈值触发策略降低交易频率和成本

### 示例3：风险平价再平衡

**输入**：组合配置，目标风险平价
**数据**：
- 当前风险贡献：股票60%，债券40%
- 目标风险贡献：股票50%，债券50%
- 组合波动率：15%
**输出**：
- 再平衡方案：降低股票权重，提高债券权重
- **结论**：风险平价再平衡，组合波动率降低20%

### 示例4：税收优化再平衡

**输入**：组合持仓，部分股票亏损
**数据**：
- 股票A：持股11个月，盈利+20%
- 股票B：持股6个月，亏损-10%
- 再平衡需求：卖出10%股票
**输出**：
- 再平衡方案：优先卖出股票B（税损收割），持有股票A至1年（免红利税）
- **结论**：税收优化再平衡，税后收益提升0.5-1%/年
