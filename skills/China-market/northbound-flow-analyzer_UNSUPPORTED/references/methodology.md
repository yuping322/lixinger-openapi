# 方法论：北向资金分析器（A股）

本技能用于**分析北向资金（沪股通/深股通）的流向、行业偏好、背离信号与风险提示**。北向资金是外资进入A股的主要渠道，其流向往往领先市场，是重要的增量资金来源和情绪指标。

## 数据口径

### 数据源与字段映射

北向资金分析需要以下数据：
- **北向资金流向**：AKShare (`stock_hsgt_north_net_flow_in_em`), 东方财富
  - 沪股通净流入、深股通净流入、北向合计净流入
  - 日频数据，T日晚间更新
- **个股持仓**：AKShare (`stock_hsgt_hold_stock_em`), Wind
  - 北向持股数量、持股市值、持股占比、持股变化
  - 日频数据，T日晚间更新
- **行业分布**：根据个股持仓聚合，使用申万一级/二级行业分类
- **市场数据**：AKShare (`stock_zh_a_hist`)
  - 上证指数、深证成指、创业板指、个股价格
  - 日频数据，实时更新

关键字段：
- `净流入额`：当日北向资金净买入金额（亿元）
- `累计净流入`：自开通以来累计净流入（亿元）
- `持股市值`：北向资金持有的A股市值（亿元）
- `持股占比`：北向持股市值 / 个股流通市值
- `持股变化`：当日持股数量变化（万股）
- `行业净流入`：按行业聚合的净流入金额

### 时间窗口与频率

- **日频监控**：每日收盘后更新，T日晚间可获取T日数据
- **周频总结**：每周汇总净流入、行业偏好、重点个股
- **月频趋势**：每月分析累计流向、持仓变化、配置调整

建议窗口：
- 短期动量：5日、10日、20日净流入
- 中期趋势：60日、120日净流入
- 长期配置：252日（年度）净流入和持仓变化
- 背离检测：20日北向流向 vs 20日指数涨跌幅

## 核心指标

### 指标列表与计算公式

1. **净流入指标**：
   - `日净流入 = 沪股通净流入 + 深股通净流入`
   - `N日累计净流入 = Σ(日净流入)` over N days
   - `N日平均净流入 = N日累计净流入 / N`
   - `净流入强度 = 日净流入 / 当日A股成交额` (%)

2. **持仓指标**：
   - `持股市值占比 = 北向持股市值 / A股流通市值` (%)
   - `个股持股占比 = 北向持股数量 / 个股流通股本` (%)
   - `持仓集中度 = Top10持股市值 / 北向总持股市值` (%)
   - `持仓变化率 = (当前持股 - 上期持股) / 上期持股` (%)

3. **行业偏好指标**：
   - `行业净流入占比 = 行业净流入 / 北向总净流入` (%)
   - `行业超配度 = 行业持股占比 - 行业市值占比` (百分点)
   - `行业流入强度 = 行业净流入 / 行业成交额` (%)

4. **背离指标**：
   - `流向-价格背离 = sign(N日净流入) != sign(N日指数涨跌幅)`
   - `背离强度 = |N日净流入百分位 - N日指数涨跌幅百分位|`
   - `持续背离天数 = 连续背离的交易日数`

5. **情绪指标**：
   - `净流入百分位 = percentile_rank(日净流入, 252日历史)`
   - `流入加速度 = (5日平均净流入 - 20日平均净流入) / 20日平均净流入`
   - `极端流入标志 = 1{日净流入 > 252日均值 + 2*标准差}` (大幅流入)

### 标准化方法

- 使用**百分位排名**对净流入进行标准化（相对252日历史）
- 使用**z-score**检测极端流入/流出（> 2倍标准差）
- 使用**行业相对**计算超配/低配（行业持股占比 - 行业市值占比）
- 使用**移动平均**平滑短期波动（5日MA、20日MA）

## 信号与阈值

### 可测试规则（Insight Rules）

Rule 1 (持续大幅净流入 → 市场上涨概率高):
IF {20日累计净流入 >= 200亿 AND 净流入百分位 >= 80 AND 流入加速度 > 0}
THEN {未来10-20个交易日，上证指数上涨概率 >= 65%，预期涨幅 >= 3%}
CONFIDENCE {0.65; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场（上证指数、沪深300），2017年沪深港通全面开通后数据最可靠}
FAILURE_MODE {政策突变（如限制外资）；地缘政治风险（中美关系恶化）；全球风险偏好下降（美股暴跌）；北向流入但市场已提前大涨（追高风险）}

Rule 2 (流向-价格背离 → 反转信号):
IF {20日净流入 > 0 AND 20日指数涨跌幅 < -3% AND 持续背离天数 >= 5}
THEN {未来5-10个交易日，市场可能见底反弹，预期反弹幅度 >= 2%}
CONFIDENCE {0.60; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场调整期，北向资金逆势流入往往是底部信号}
FAILURE_MODE {基本面恶化（业绩暴雷、经济数据差）；流动性危机（外资被动赎回）；背离持续时间过长（> 20天）表明趋势未改}

Rule 3 (行业集中流入 → 行业轮动):
IF {某行业5日净流入占比 >= 30% AND 行业流入强度 >= 5% AND 行业超配度上升}
THEN {未来5-10个交易日，该行业相对市场超额收益 >= 2%}
CONFIDENCE {0.58; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {申万一级行业，流动性好的行业（金融、消费、科技）信号更强}
FAILURE_MODE {行业已大幅上涨（追高）；行业基本面转差；北向流入是被动配置（指数调整）而非主动增持}

Rule 4 (极端流出 + 持仓占比高 → 短期压力):
IF {日净流出 <= -100亿 AND 净流入百分位 <= 10 AND 持股市值占比 >= 4%}
THEN {未来3-5个交易日，市场面临调整压力，预期下跌 >= 1.5%}
CONFIDENCE {0.62; 初步估计；需要历史验证}
APPLICABLE_UNIVERSE {A股市场，北向持股占比高时（>= 4%）流出冲击更大}
FAILURE_MODE {流出是技术性（月末、季末调仓）；国内资金接盘（如国家队、保险）；市场已提前下跌（流出滞后）}

### 触发/解除/无效化条件

- **触发监控**：
  - 日净流入/流出 >= 50亿（显著流向）
  - 20日累计净流入 >= 200亿或 <= -200亿（趋势性流向）
  - 流向-价格背离持续 >= 5天（背离信号）
  - 某行业5日净流入占比 >= 30%（行业集中）

- **解除监控**：
  - 净流入恢复正常（-20亿 ~ +20亿区间持续5天）
  - 背离消失（流向与价格同向持续5天）
  - 行业流入分散（单行业占比 < 15%持续5天）

- **无效化**：
  - 数据缺失或延迟 > 2天（节假日除外）
  - 沪深港通暂停交易（台风、系统故障）
  - 政策重大变化（如限制外资持股比例）
  - 市场异常波动（熔断、涨跌停超过50%个股）

### 阈值选择依据

- **50亿净流入/流出**：约占日均成交额的0.5-1%，是显著但非极端的流向
- **200亿20日累计**：约占20日成交额的1%，表明趋势性配置
- **80/20百分位**：对应252日历史的前20%/后20%，是较强但非极端的信号
- **30%行业占比**：单行业占比超过1/3，表明明显的行业偏好
- **4%持股市值占比**：北向持股占A股流通市值的4%左右（2023-2024年水平），是重要的边际力量

## 边界条件与降级策略

### 数据缺失/异常值处理

- **数据缺失**：
  - 节假日：使用前一交易日数据，标注"节假日无数据"
  - 系统故障：使用东方财富网页数据作为备份，标注"备用数据源"
  - 个股停牌：从行业聚合中剔除，标注"剔除停牌股"

- **异常值处理**：
  - 单日净流入 > 500亿或 < -500亿：检查是否数据错误，若确认则标注"极端流入/流出"
  - 个股持股占比 > 30%：检查是否计算错误（流通股本变化），若确认则标注"高持股占比"
  - 行业净流入占比 > 80%：检查是否单一大盘股影响，若确认则标注"集中流入"

### 降级策略

- **AKShare接口不稳定**：
  - 备用数据源1：东方财富网页爬取（`http://data.eastmoney.com/hsgt/`）
  - 备用数据源2：Wind API（需付费）
  - 备用数据源3：手动输入（从交易所官网获取）
  - 降级标注："使用备用数据源，可能有延迟"

- **个股持仓数据缺失**：
  - 使用行业聚合数据代替个股分析
  - 使用Top10持股数据代替全量持仓
  - 降级标注："个股数据不全，仅提供行业分析"

- **历史数据不足**（< 252天）：
  - 使用可用历史计算百分位（标注样本期）
  - 使用固定阈值代替百分位（如50亿代替80百分位）
  - 降级标注："历史数据不足，阈值可能不准确"

## A股特殊注意

### 1. T+1交易制度影响

- **当日流入次日才能卖出**：北向资金当日买入的股票次日才能卖出，因此：
  - 当日大幅流入后，次日抛压较小（锁定效应）
  - 连续流入比单日流入更有持续性
  - 流出时可能集中在开盘（T日买入T+1日卖出）

### 2. 涨跌停限制影响

- **涨停板限制买入**：个股涨停时北向资金无法买入，导致：
  - 流入可能延后到次日（涨停打开后）
  - 行业流入可能分散到其他个股
  - 涨停股的持仓变化滞后于实际意图

- **跌停板限制卖出**：个股跌停时北向资金无法卖出，导致：
  - 流出可能延后到次日（跌停打开后）
  - 被动持仓增加（想卖卖不出）
  - 次日开盘可能集中抛售

### 3. 停牌影响

- **重大事项停牌**：个股停牌期间北向资金无法交易，导致：
  - 持仓被动锁定（无法调整）
  - 复牌后可能集中买入/卖出
  - 行业数据失真（停牌股不计入）

### 4. 额度限制

- **每日额度**：沪股通/深股通各有每日额度（520亿），用完即停止交易：
  - 额度用尽时（剩余额度 <= 0）：当日无法继续流入
  - 额度预警（剩余额度 < 100亿）：流入可能受限
  - 节假日前额度紧张：提前配置导致流入集中

### 5. 交易时间差异

- **港股休市A股开市**：香港节假日时北向资金无法交易：
  - 佛诞日、圣诞节等香港特有假期
  - 台风等突发事件导致港股休市
  - 需要提前标注港股休市日期

### 6. 汇率影响

- **人民币贬值**：北向资金以人民币计价，汇率波动影响：
  - 人民币贬值时，外资买入成本上升（汇兑损失）
  - 人民币升值时，外资买入成本下降（汇兑收益）
  - 需要考虑汇率对流向的影响（尤其是大幅波动时）

### 7. 监管政策变化

- **持股比例限制**：单一外资持股不得超过10%，所有外资合计不得超过30%：
  - 接近上限时（持股占比 > 28%）：流入受限
  - 触及上限时：强制停止买入
  - 需要监控个股外资持股占比

- **行业限制**：部分行业限制外资持股（如军工、传媒）：
  - 这些行业北向资金无法配置
  - 行业分析时需要剔除限制行业

### 8. 数据更新时间

- **T日晚间更新**：北向资金数据在T日收盘后更新（通常19:00-20:00）：
  - 盘中无法获取实时数据（仅有额度余额）
  - 日内分析需要使用额度余额推算
  - 次日早盘前可获取前日完整数据

### 9. 被动配置影响

- **指数调整**：MSCI、富时罗素等指数调整时，北向资金被动配置：
  - 纳入/剔除个股时有大量被动流入/流出
  - 权重调整时有被动增持/减持
  - 需要区分主动配置和被动配置

### 10. 南向资金对比

- **南向资金（港股通）**：A股投资者买入港股，与北向资金相反：
  - 南向流出 + 北向流入 = 风险偏好上升
  - 南向流入 + 北向流出 = 风险偏好下降
  - 需要结合南向资金综合判断

## 回测说明（最小化）

- **回测设计**：
  - 每日收盘后计算信号（T日晚间）
  - 次日开盘买入/卖出（T+1日）
  - 持有期：5日/10日/20日
  - 基准：上证指数、沪深300

- **性能指标**：
  - 信号胜率（信号后N日上涨概率）
  - 平均超额收益（信号后N日收益 - 基准收益）
  - 夏普比率、最大回撤

- **证伪条件**：
  - 信号胜率 <= 50%（不优于随机）
  - 平均超额收益 <= 0（不优于基准）
  - 夏普比率 <= 0.5（风险调整后收益不佳）

- **敏感性分析**：
  - 测试不同阈值（50亿 vs 100亿净流入）
  - 测试不同窗口（10日 vs 20日累计）
  - 测试不同市场环境（牛市 vs 熊市 vs 震荡市）

## 使用示例

### 示例1：日常监控

**输入**：2024-02-15（周四）收盘后
**输出**：
- 当日净流入：+85亿（沪股通+50亿，深股通+35亿）
- 5日累计：+320亿（加速流入）
- 20日累计：+580亿（持续流入）
- 净流入百分位：78%（较强）
- 行业偏好：金融+45亿（53%），消费+25亿（29%），科技+15亿（18%）
- 背离检测：无背离（流入 + 指数上涨）
- **结论**：北向资金持续流入，金融板块受青睐，市场情绪偏暖，短期继续看多

### 示例2：背离信号

**输入**：2024-03-20（周三）收盘后
**输出**：
- 当日净流入：+65亿
- 20日累计：+450亿（持续流入）
- 20日指数涨跌幅：-4.2%（调整）
- 持续背离天数：7天
- **结论**：北向资金逆势流入，市场调整但外资持续买入，可能是底部信号，关注反弹机会

### 示例3：极端流出

**输入**：2024-04-10（周三）收盘后
**输出**：
- 当日净流出：-125亿（极端流出）
- 净流入百分位：5%（极低）
- 持股市值占比：4.2%（较高）
- VIX指数：28（恐慌）
- **结论**：北向资金大幅流出，市场面临短期调整压力，建议降低仓位或对冲风险
